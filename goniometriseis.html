<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Εφαρμογή γωνιομετρήσεων</title>
    <!--<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">-->
</head>
<body>
    <div class="pill-nav">
    <a id="initial" onclick="goToPage('https://nik-v123.github.io/topografikesEfarmoges/')">Αρχική</a>
    <a onclick="goToPage('https://nik-v123.github.io/topografikesEfarmoges/odeusi.html')">Επίλυση όδευσης</a>
    <a class="active">Εφαρμογή γωνιομετρήσεων</a>
    <a onclick="goToPage('https://nik-v123.github.io/topografikesEfarmoges/instructions.html')">Οδηγίες χρήσης της εφαρμογής "Επίλυση όδευσης"</a>
    <a onclick="goToPage('https://nik-v123.github.io/topografikesEfarmoges/points-plot.html')">Εφαρμογή ραπορταρίσματος σημείων σε διάγραμμα</a>
    <a onclick="goToPage('https://nik-v123.github.io/topografikesEfarmoges/plot-on-map.html')">Εφαρμογή ραπορταρίσματος σημείων σε χάρτη</a>
    <!--<li class="right"><a href="instructions.html">Οδηγίες χρήσης</a></li>-->
    <div style="display: flex; align-items: center; padding: 4px;">
    <button class="btn2" onclick="addRow()">Προσθήκη γραμμής</button>
    <button class="btn2" onclick="solveAndSetData()">Επίλυση</button>
    <button id="clearButton" class="btn2" onclick="clear2()">Καθαρισμός</button><br><br></div>
    </div>

<div id="table-div" style="padding:20px; margin-top:70px;">
    <h2>Εφαρμογή γωνιομετρήσεων</h2>
    <b>Προσοχή:</b> 
    <ul>
    <li>Η εφαρμογή είναι δοκιμαστική έκδοση και μπορεί να υπάρχουν σφάλματα. (This application is a beta version and may contain errors.)</li>
    <li>Τα δεδομένα που φαίνονται στον πίνακα με την εκκίνηση της εφαρμογής είναι ενδεικτικά του τρόπου συμπλήρωσης και δεν θα μπορούσαν <br>να αποτελούν πραγματικές μετρήσεις, επειδή οι πραγματικές μετρήσεις περιέχουν σφάλματα.</li>
    <li>Κατα την εισαγωγή των δεδομένων, χρησιμοποιήστε την τελειά (.) ως διαχωριστή δεκαδικών ψηφίων!</li>
    </ul>
    <br>Εισάγετε τον αριθμό των περιόδων: &nbsp <input id="periodsCountTxt" type="Number" value="4"><br><br>
    <table id="editableTable">
        <thead>
            <tr style="background-color: lightskyblue;">
                <th style=" padding: 8px;">Περίοδος</th>
                <th style=" padding: 8px;">Σημείο σκόπευσης</th>
                <th style=" padding: 8px;">1η θέση τηλεσκοπίου</th>
                <th style=" padding: 8px;">2η θέση τηλεσκοπίου</th>
                <th style=" padding: 8px;">Μέσος όρος*</th>
                <th style=" padding: 8px;">Μέση ανηγμένη τιμή</th>
                <th style=" padding: 8px;">Γενικός μέσος όρος</th>
                <th style=" padding: 8px;">Διαγραφή γραμμής</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 1"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 1"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="0.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="200.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td style="font-size: 15px;">
                    Δεν μπορεί να διαγραφεί, χρειάζονται τουλάχιστον 2 γραμμές μετρήσεων!
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 1"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 2"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="176.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="376.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td style="font-size: 15px;">
                    Δεν μπορεί να διαγραφεί, χρειάζονται τουλάχιστον 2 γραμμές μετρήσεων!
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 2"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 1"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="50.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="250.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 2"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 2"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="226.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="426.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 3"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 1"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="100.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="300.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 3"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 2"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="276.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="476.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 4"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 1"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="150.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="350.0000"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
            <tr>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Περίοδος 4"></td>
                <td contenteditable="false"><input type="text" class="tableInputs" value="Σημείο 2"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="326.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs" value="526.4567"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td contenteditable="false"><input type="Number" class="tableInputs"></td>
                <td>
                    <button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>
                </td>
            </tr>
        </tbody>
    </table>

    <br>
    <H4>* Ο μέσος όρος υπολογίζεται με βάση την σχέση: (1η θέση τηλεσκοπίου + (2η θέση τηλεσκοπίου - 200)) / 2</H4>

    <br>

    <label>Όνομα αρχείου αποτελεσμάτων:</label><br><br>
    <input id="resultsFileNameTxt" class="input2" value="goniometrisiResults"><br><br>
    <button class="btn2" onclick="saveResults()">Αποθήκευση αποτελεσμάτων</button><br><br>

    <label>Όνομα αρχείου δεδομένων:</label><br><br>
    <input id="dataFileNameTxt" class="input2" value="goniometrisiData"><br><br>
    <button class="btn2" onclick="saveData()">Αποθήκευση δεδομένων</button><br><br>

    <button class="btn2" onclick="openData()">Εισαγωγή δεδομένων</button>

    <input type="file" id="fileInput" style="display: none;" />
    
    <br><br>Creator: Nikos Ververidis<br>
    <br>Code availiable under GNU Affero General Public License v3.0 at <a href="https://github.com/nik-v123/topografikesEfarmoges">https://github.com/nik-v123/topografikesEfarmoges</a>
    <br><br>
    <br>

    </div>
    </body>
    </html>

    <style>
        table {
            font-size: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 0px;
            text-align: left;
        }
        .btn {
            cursor: pointer;
            margin: 2px;
            background-color: rgb(255, 92, 92);
            border-radius: 25px;
            padding: 5px;
            color: white;
            border: none;
            transition-duration: 0.4s;
        }
        #periodsCountTxt{
            font-size: 20px;
            font-family: Arial;
            width: 50px;
        }
        
        .input2{
            font-size: 20px;
            font-family: Arial;
            size: 20;
        }
        .btn2{
            font-size: 15px;
            font-family: Arial;
            cursor: pointer;
            margin: 2px;
            background-color: rgb(73, 108, 72);
            color: white;
            border-radius: 25px;
            padding: 5px;
            border: none;
            transition-duration: 0.4s;
        }
        #clearButton{
            background-color: rgb(255, 92, 92);
            border: none;
            font-size: 15px;
            font-family: Arial;
            cursor: pointer;
            margin: 2px;
            color: white;
            border-radius: 25px;
            padding: 5px;
            transition-duration: 0.4s;
        }
        .btn2:hover {
            background-color: rgba(73, 108, 72, 0.76);
        }
        .btn:hover{
            background-color: rgba(255, 92, 92, 0.763);
        }
        #clearButton:hover{
            background-color: rgba(255, 92, 92, 0.763);
        }
        .btn:active{
            background-color: rgb(255, 92, 92);
        }
        #clearButton:active{
            background-color: rgb(255, 92, 92);
        }
        .btn2:active{
            background-color: rgb(73, 108, 72);
        }
        .tableInputs{
            width: 80%;
            height: 100%;
            font-size: 20px;
            border: none;
            padding: 8px;
            text-align: left;
            font-family: Generic fonts;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
        }

        /*Navbar*/

        .pill-nav a {
      display: inline-block;
      color: black;
      text-align: center;
      padding: 14px;
      text-decoration: none;
      font-size: 17px;
      border-radius: 5px;
    }
    
    .pill-nav a:hover {
      background-color: #ddd;
      color: black;
    }
    
    .pill-nav a.active {
      background-color: dodgerblue;
      color: white;
    }
        .pill-nav {
      position: sticky;
      top: 0;
      overflow: hidden;
        background-color: white;
    }
        @media screen and (max-width: 600px) {
    .pill-nav a{
      display: none;
    }
    #initial {
      display:inline-block;
    }
  }
    </style>

    <script>
        //global variables

        resultsToSave = "";

        dataToSave = "";

        function goToPage(pageUrl){
            let confirmation = confirm("Ολα τα δεομένα σε αυτή την σελίδα θα χαθούν. Θέλετε να συνεχίσετε;");
            if(confirmation == false){
            }
            else{
                location.href = pageUrl;
            }
        }


        function addRow() {
            let table = document.getElementById("editableTable").getElementsByTagName('tbody')[0];
            let newRow = table.insertRow();
            
            let cells = [];
            for (let i=0; i<=7; i++){
                cells.push(newRow.insertCell(i));
            }

            for (let i=0; i<=1; i++){
                //cells[i].contentEditable = "false";
                cells[i].innerHTML = '<input type="text" class="tableInputs">';
            }
            
            for (let i=2; i<7; i++){
                cells[i].innerHTML = '<input type="Number" class="tableInputs">';
            }

            cells[7].innerHTML = '<button class="btn" onclick="deleteRow(this)">Διαγραφή γραμμής</button>';
        }

        function deleteRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function saveTableData() {
            let table = document.getElementById("editableTable");
            let rows = table.getElementsByTagName("tbody")[0].rows;
            let tableData = [];

            for (let i = 0; i < rows.length; i++) {
                let cells = rows[i].cells;
                let rowData = [];
                for (let j = 0; j < cells.length - 1; j++) { // Exclude last column (buttons)
                    rowData.push(cells[j].firstChild.value);
                }
                tableData.push(rowData);
            }

            
            return tableData;
        }

    function setCell(i,j,setValue){
        let table = document.getElementById("editableTable");
        let rows = table.getElementsByTagName("tbody")[0].rows;
        let cells = rows[i].cells;
        cells[j].firstChild.value = setValue;
    }
    function clear1(){
        data = saveTableData();
        rowsCount = data.length;
        columnsCount = data[0].length;
        for (i=0; i<rowsCount; i++){
            for (j=0; j<columnsCount; j++){
                setCell(i,j,"");
            }
        }
        table = document.getElementById("editableTable");
        for (let i=0; i<rowsCount-2; i++){
            table.deleteRow(-1);
        }
    }

    function clear2(){
        let confirmation = confirm("Είστε σίγουροι οτι θέλετε να διαγραφούν όλα τα δεομένα;");
        if(confirmation == false){
        }
        else{
            clear1();
        }
    }

    //function to process angle measurements
    function goniometrtiseis(firstPosition, secondPosition, periodsCount){
        
        
        let k = (200 / periodsCount).toFixed(0);
        
        let allAvg = [];
        let allMesiAnigmeniTimi = [];
        //let allMeans = [];
        let mean = 0;
        let i = 0;
        for (let j=0; j<periodsCount; j++){
            i=2*j;
            let firstAvg = (firstPosition[i] + secondPosition[i]-200) / 2;
            let secondAvg = (firstPosition[i+1] + secondPosition[i+1]-200) / 2;
            let mesiAnigmeniTimi = secondAvg - firstAvg;
            //let mean = (firstAvg + secondAvg)/2;

            allAvg.push(firstAvg);
            allAvg.push(secondAvg);
            //allMesiAnigmeniTimi.push(mesiAnigmeniTimi1);
            allMesiAnigmeniTimi.push(mesiAnigmeniTimi);
            //allMeans.push(mean);
            

            //i = i+2;
        }

        let sum = 0;
        for(let i=0; i<allMesiAnigmeniTimi.length; i++){
            sum = sum + allMesiAnigmeniTimi[i]
        }
        mean = sum / allMesiAnigmeniTimi.length;

        return [allAvg,allMesiAnigmeniTimi,mean];
    }

    //function to show the results
    function setData(allAvg,allMesiAnigmeniTimi,mean,rc){
        
        for (let i=0; i<allAvg.length; i++){
            setCell(i,4,allAvg[i].toFixed(4));
        }
        for (let i=0; i<allMesiAnigmeniTimi.length; i++){
            setCell(2*i+1,5,allMesiAnigmeniTimi[i].toFixed(4));
        }
        setCell((rc-1),6,mean.toFixed(4));
        //document.getElementById("periodsCountTxt").value = "dg: "+dg.toFixed(5).toString()+" dgi: "+dgi.toFixed(5).toString()+" wx: "+wx.toFixed(4).toString()+" wy: "+wy.toFixed(4).toString();
    }

    //solve and show the results
    function solveAndSetData(){
        dataToSave = "";
        resultsToSave = "";
        let data = saveTableData();

        let pointNames = [];
        let periodNames =[];
        let fp = []; //first position
        let sp = []; //second position

        let pc = 0; //period count

        pc = parseInt(document.getElementById("periodsCountTxt").value);

        if (Number.isNaN(pc)){
            alert(`Πρέπει να οριστεί κάποιος αριθμός περιόδων.`);
        }
        else{
            let rowsCount = data.length;

            if (rowsCount != 2*pc){
                alert(`Έχουν συμπληρωθεί ${rowsCount} γραμμές, αλλά ο αριθμός των περιόδων είναι ${pc}!`);
            }
            else{
                for (let i=0; i<rowsCount; i++){
                    periodNames.push(data[i][0]);
                    pointNames.push(data[i][1]);
                    fp.push(parseFloat(data[i][2]));
                    sp.push(parseFloat(data[i][3]));
                }
                let [allAvg,allMesiAnigmeniTimi,mean] = goniometrtiseis(fp,sp,pc);
                
                
                setData(allAvg,allMesiAnigmeniTimi,mean,rowsCount);
                let newTableData = saveTableData();

                for (let n=0; n<newTableData.length; n++){
                    
                    resultsToSave = resultsToSave + newTableData[n].toString() + "\n";

                }

                for (let m=0; m<rowsCount; m++){
                    if(m==(rowsCount-1)){
                        dataToSave = dataToSave + periodNames[m].toString() + "," + pointNames[m].toString() + "," + fp[m].toString() + "," + sp[m].toString();
                    }
                    else{
                        dataToSave = dataToSave + periodNames[m].toString() + "," + pointNames[m].toString() + "," + fp[m].toString() + "," + sp[m].toString() + "\n";
                    }
                }
            }
        }    
    }
    function saveTxt(fname,txtToSave){
            let blobdtMIME = new Blob([txtToSave], { type: "text/plain" });
            let url = URL.createObjectURL(blobdtMIME);
            let anele = document.createElement("a");
            anele.setAttribute("download", fname);
            anele.href = url;
            anele.click();
            console.log(blobdtMIME);
        }

        function saveResults(){
            let resultsfname = document.getElementById("resultsFileNameTxt").value;
            if (resultsfname == "" || resultsfname == NaN){
                alert("Λάθος όνομα για το αρχείο αποτελεσμάτων!");
            }
            else{
                saveTxt(resultsfname+".txt",resultsToSave);
            }
        }

        function saveData(){
            let datafname = document.getElementById("dataFileNameTxt").value;
            if (datafname == "" || datafname == NaN){
                alert("Λάθος όνομα για το αρχείο δεδομένων!");
            }
            else{
                saveTxt(datafname+".txt",dataToSave);
            }
        }

        function openData(){
            let confirmation = confirm("Με το άνοιγμα αρχείου θα διαγραφούν όλα τα υπάχοντα δεδομένα του πίνακα. Θέλετε να συνεχίσετε;");
            
            if(confirmation == false){
            }
            else{
                clear1();
                const input = document.getElementById('fileInput');
                input.click();

                input.onchange = () => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;

                    let dataStr = content;
                    
                    let lines = dataStr.split(/\r?\n|\r|\n/g);
                    

                    
                    
                    if (lines.length > 2){
                        
                        let extraRows = lines.length-2;
                        
                        for (let i=0; i<extraRows; i++){
                            
                            addRow()
                        }
                    }

                    for (let a=0; a<lines.length; a++){
                        
                        let splited = (lines[a]).split(",");
                        for (let b=0; b<4; b++){
                            setCell(a,b,splited[b]);
                        }
                    }
            };
            reader.readAsText(file); // Or readAsDataURL / readAsBinaryString
        };
    }
}

        //functions for keys
        document.addEventListener('DOMContentLoaded', () => {
        const table = document.getElementById('editableTable');

        table.addEventListener('keydown', (event) => {
            const currentCell = event.target;

            // Ensure the target is an editable table cell
            if (currentCell.tagName === 'TD' && currentCell.contentEditable === 'true') {
            const currentRow = currentCell.closest('tr');
            const cellIndex = currentCell.cellIndex;
            let targetCell = null;

            switch (event.key) {
                case 'Enter':
                case 'ArrowDown':
                event.preventDefault(); // Prevent new line for Enter, prevent page scroll for ArrowDown
                const nextRowDown = currentRow.nextElementSibling;
                if (nextRowDown) {
                    targetCell = nextRowDown.cells[cellIndex];
                }
                break;

                case 'ArrowUp':
                event.preventDefault(); // Prevent page scroll
                const prevRowUp = currentRow.previousElementSibling;
                // Ensure the previous row is not part of thead (if present)
                if (prevRowUp && prevRowUp.tagName === 'TR' && prevRowUp.closest('tbody')) {
                    targetCell = prevRowUp.cells[cellIndex];
                }
                break;

                case 'ArrowLeft':
                event.preventDefault(); // Prevent page scroll
                if (cellIndex > 0) {
                    targetCell = currentRow.cells[cellIndex - 1];
                }
                break;

                case 'ArrowRight':
                event.preventDefault(); // Prevent page scroll
                if (cellIndex < currentRow.cells.length - 1) {
                    targetCell = currentRow.cells[cellIndex + 1];
                }
                break;
            }

            // If a target cell was found and it's editable, focus it
            if (targetCell && targetCell.contentEditable === 'true') {
                targetCell.focus();
            }
            }
        });
        });
    </script>
</body>

</html>














